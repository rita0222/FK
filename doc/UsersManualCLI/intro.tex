\chapter{さあはじめよう} \label{chap:intro} ~

一般的に、3次元コンピュータグラフィックス (以下 3DCG) のために
書かれたソースコードは、かなり長くなることが多い。
ただ単に直方体が回転しているプログラムを書くために、500 行以上必要な
場合もある。むしろ、そうでないプラットフォームの方が
珍しい。何故か？

何故なら、3DCG アプリケーションには考えなければならない要素が
とても多いからである。先ほど例に出した直方体の回転に関しても、
次のような要素を考慮する必要がある。
\begin{itemize}
 \item 「直方体」をどうやって生成するか？
 \item 回転をどうやって実現するか？
 \item 立体の色はどうするのか？
 \item 背景色はどうするのか？
 \item ウィンドウをどうやって作成するのか？
 \item 作成したウィンドウにどうやって表示するのか？
 \item アニメーションをどうやって実現するのか？
 \item アニメーションしている間、マウスやキーボードをどう扱うのか？
\end{itemize}
これらを全てプログラムソースとして書いていくと、すぐに 500 行にも
1000 行にも簡単に達してしまう。

FK ツールキット (以下 FK) は、このような状況を打破するために産み出された。
複雑に絡んでいる各要素を整理し、オブジェクト指向の概念を利用して
極力簡略化できるように設計されている。実際に、直方体を回転させる
プログラムを記述してみよう。
\section{直方体回転のサンプルプログラム}
\begin{breakbox}
\begin{small}
\begin{verbatim}
 1: using System;
 2: using FK_CLI;
 3: 
 4: namespace fk_tmp
 5: {
10:     class Program
11:     {
12:         static void Main(string[] args)
13:         {
14:             var block = new fk_Block(10.0, 20.0, 15.0);
15:             var model = new fk_Model();
16:             var fk_win = new fk_AppWindow();
17: 
18:             // 色パレットの初期化
19:             fk_Material.InitDefault();
20: 
21:             // モデルに直方体を設定
22:             model.Shape = block;
23: 
24:             // モデルの色を黄色に設定
25:             model.Material = fk_Material.Yellow;
26: 
27:             // カメラの位置と方向を設定
28:             fk_win.CameraPos = new fk_Vector(0.0, 0.0, 100.0);
29:             fk_win.CameraFocus = new fk_Vector(0.0, 0.0, 0.0);
30: 
31:             // ウィンドウにモデルを設定
32:             fk_win.Entry(model);
33: 
34:             // ウィンドウのサイズを設定
35:             fk_win.Size = new fk_Dimension(600, 600);
36: 
37:             // ウィンドウを開く
38:             fk_win.Open();
39: 
40:             while(fk_win.Update() == true)
41:             {
42:                 // 直方体を Y 軸を中心に回転させる。
43:                 model.GlRotateWithVec(0.0, 0.0, 0.0, fk_Axis.Y, 0.01);
44:             }
45:         }
46:     }
47: }
\end{verbatim}
\end{small}
\end{breakbox}

~ \\ ~ \\
以上のように、47 行で直方体が回転するアニメーションを作成することができる。
空行やコメントを除けば、わずか 30 行である。各処理の詳細な解説は
次章以降に譲るとして、ここでは大きな流れを見ていこう。

\section{4 つの``レイヤー''}
プログラムの実際の中身を分析する前に、FK の
根幹をなす 4 種類の ``レイヤー'' である「形状」、「モデル」、
「シーン」、「ウィンドウ」を簡単に解説する。

「形状」は、文字通り立体形状を表す。FK では、形状として
直方体、球、平面、円盤、線分、点など様々なものを、変数を1つ
定義するだけで作成することができる。また、様々な 3次元データファイル形式を
入力することもできる。もちろん、その場合も「形状」を表すには
変数を1つ準備するだけでよい。

「モデル」は、形状に対して位置や方向などを持たせた存在である。
「形状」と「モデル」の概念が分離しているのには理由がある。
例えば、同じ形状を持つ 100 台の車のカーチェイスゲームを想定してみよう。
このとき、100 台分
全てのデータをメモリ上に確保するのは大変無駄である。しかし、100 台の
車は位置も方向も速度も、おそらく色も違うことであろう。したがって、
これらは別々に存在していなければならない。こんなときに「モデル」の概念が
役立つ。まず「形状」として 1 個の車体を準備し、100 個の「モデル」を
準備する。各モデルは形状として先ほどの車体を設定し、それぞれ固有の
位置や方向や色を持てば良い。これで、データ量の節約と 100 台の車の
存在を両立することができる。また、モデルは瞬時に設定する形状を変更することが
できるので、形状を\bou{入れ替える}ことで変形アニメーションを簡単に実現
することもできる。

「シーン」は、複数のモデルと1つのカメラから成り立っており、
全体で1つの ``空間'' を表現する。ここには、実際に描画するモデルを
全て登録しておく。最後に紹介する「ウィンドウ」はキャンバスのようなもので、
ここに「シーン」を設定することで ``空間'' が実際に
描写される。「シーン」と「ウィンドウ」は完全に独立した
存在なので、ウィンドウに描画されるシーンを簡単に切り替えたり、逆に
複数のウィンドウに同じシーンを描画することも簡単にできる。

\section{プログラムの概要}
では、実際にサンプルプログラムについて解説していこう。

1 〜 6 行目は C\# で名前空間の省略対象を設定している。
1 〜 5 行目は Visual Studio が自動的に記述してくれるので、
6 行目の「\verb+using FK_CLI;+」を忘れずに行っておこう。

14 〜 16 行目では各種変数の宣言を行っている。
各変数の詳細は以下の通りである。

\begin{table}[H]
\caption{変数の意味}
\label{tbl:samp1}
\begin{center}
\begin{tabular}{|c|l|}
\hline
変数名 & 解説 \\ \hline \hline
block & 直方体形状を表す変数。\\ \hline
model & 直方体の「モデル」を表す変数。\\ \hline
fk\_win & ウィンドウを表す変数。\\ \hline
\end{tabular}
\end{center}
\end{table}

変数を準備することは、その時点でそのクラスが表現する「もの (オブジェクト)」
を作成することだと考えてくれればよい。例えば、14 行目の直方体変数の宣言は、
この記述によって直方体を生成したということになる。他の変数、
例えばモデルやウィンドウも全て変数の定義の時点で生成される。あとは、
これらオブジェクトに対して適切な設定を行っていけばよい。

19 行目の記述は、様々な色 (マテリアル) を初期化するための関数で、これは
何か色設定を行う前に記述しておく必要がある。

22 行目はモデル「model」に対して形状を設定している部分である。
ここでは形状として「block」を設定している。

25 行目では、モデルの色として「Yellow」を採用している。ちなみに、
デフォルトでは灰色が設定されている。

28,29 行目は、カメラに対して位置と方向を設定している。
28 行目の「setCameraPos」関数は、カメラの位置を指定する関数である。
また、29 行目の「setCameraFocus」はカメラの被写体の位置 --- これは CG 用語で
「注視点」とか「注目点」などと呼ばれている --- を指定する関数である。
従って、ここではカメラ位置を \((0, 0, 100)\) に置き、原点の方向を
向いていることになる。

32 行目は、準備したモデルをウィンドウに登録している部分である。
FK では、形状やモデルは単に準備しただけでは表示対象とはならず、
このようにウィンドウに登録して初めて実際に描画されるようになる。

38 行目は fk\_win を実際に描画する関数である。この関数を
呼んだ時点ではじめてウィンドウが実際に画面に現れる。

40 〜 44 行目は while ループとなっており、
これがプログラムの「メインループ」となる。
40 行目の while 文の中にある「fk\_win.Update()」は
現在の各モデル等に設定された情報に従い、3Dシーンを再描画するものである。
while 文中で各モデルの変化を記述していくことで、
アニメーションプログラムが実現されている。
なお、「Update()」メソッドは正常に表示されている場合は true を返し、
表示されていない場合に false を返す仕様となっている。
従って、この while ループはウィンドウが閉じられた場合に終了する仕組みとなる。

43 行目では、直方体を持つモデル「model」を \(y\) 軸を中心に
回転させている。「GlRotateWithVec」メソッドは、モデルを回転させる
メソッドである。ここでは、原点を中心に 0.01 ラジアン \(\cong 0.57^\circ\)
ずつ回転させている。

\section{作成できる``形状''の種類}

FK 中で作成できる基本的な「形状」には、現在次のようなものが用意されている。
\begin{table}[H]
\caption{形状を表すクラス群}
\label{tbl:shapeclass}
\begin{small}
\begin{center}
\begin{tabular}{|c|c|l|}
\hline
形状 & クラス名 & 必要な引数 \\ \hline \hline
点 & fk\_Point & 位置ベクトル \\ \hline
線分 & fk\_Line & 両端点の位置ベクトル \\ \hline
ポリライン & fk\_Polyline & 各頂点の位置ベクトル \\ \hline
閉じたポリライン & fk\_Closedline & 各頂点の位置ベクトル \\ \hline
多角形平面 & fk\_Polygon & 各頂点の位置ベクトル \\ \hline
円 & fk\_Circle & 分割数、半径 \\ \hline
直方体 & fk\_Block & 縦、横、高さ \\ \hline
球 & fk\_Sphere & 分割数、半径 \\ \hline
角柱(円柱) & fk\_Prism & 角数、上面と底面の内接円半径、高さ \\ \hline
角錐(円錐) & fk\_Cone & 角数、底面の内接円半径、高さ \\ \hline
インデックスフェースセット & fk\_IndexFaceSet & ファイル名等 \\ \hline
ソリッドモデル & fk\_Solid & ファイル名 \\ \hline
矩形テクスチャ & fk\_RectTexture & 画像ファイル名 \\ \hline
三角形テクスチャ & fk\_TriTexture & 画像ファイル名 \\ \hline
メッシュテクスチャ & fk\_MeshTexture & 画像ファイル名 \\ \hline
IFSテクスチャ & fk\_IFSTexture & 画像ファイル名 \\ \hline
文字列板 & fk\_TextImage & 文字列またはテキストファイル \\ \hline
パーティクル & fk\_ParticleSet & 様々な設定 \\ \hline
光源 & fk\_Light & タイプ \\ \hline
\end{tabular}
\end{center}
\end{small}
\end{table}

これらの変数を定義するときは、最初に初期値として様々な設定を行うことになる。
例えば fk\_Point 型、つまり空間上の「点」を表す変数を定義するとき、
その点の位置を次のようにして設定することができる。
\\
\begin{screen}
\begin{verbatim}
    var point = new fk_Point(10.0, -5.0, 20.0);
\end{verbatim}
\end{screen}
\\

この例の場合は、点の位置を \((10, -5, 20)\) として設定している。
このように、各形状クラスにはそれぞれ初期設定の方法が用意されている。
具体的な設定項目については第 \ref{chap:shape} 章で詳しく述べている。

例えば、サンプルプログラムで回転する形状を直方体ではなく円盤に
したいのであれば、14 行目の直方体の部分を
\\
\begin{screen}
\begin{verbatim}
    var circle = new fk_Circle(4, 20.0);
\end{verbatim}
\end{screen}
~ \\
と変更し、22 行目の block を circle に変更するだけでよい。

\section{モデルの制御}
FK では、モデルに対して非常に豊富な機能を提供している。
FK に限らず、一般的な 3DCG のプログラム中で最も多くの作業を必要と
するのがこのモデルの制御である。大抵の 3D プログラミング環境では、
座標軸回りの回転、平行移動、拡大縮小といった限られた命令セットしか
準備されていないことが多い。プログラマはこれらを巧みに利用して
モデルを制御することになるが、この部分の実現が思いの外難しい。
というのも、実現には非常に難解な数式処理を必要とするからである。
FK は、プログラマがそのような数学をあまり意識することなく
モデルを扱う方法を何種類も提供し、サポートしている。詳細は
\ref{chap:model} 章に全て網羅してあるので、ここでは
ダイジェストとして一部機能を紹介する。
\\
\begin{screen}
\begin{verbatim}
var model = new fk_Model();

// (50, 10, -20) へ移動
model.GlMoveTo(50.0, 10.0, -20.0);

// (10, 20, 0) だけ平行移動
model.GlTranslate(10.0, 20.0, 0.0);

// (0, 0, 100) の方を向かせる
model.GlFocus(0.0, 0.0, 100.0);

// モデルの向きを (1, 1, 1) にする
model.GlVec(1.0, 1.0, 1.0);

// モデルの位置を (0, 10, 0) を中心に x 軸方向に
// 0.1 ラジアン回転した位置に移動する (向きはそのまま)
model.GlRotate(0.0, 10.0, 0.0, fk_Axis.X, 0.1);

// GlRotate の機能に加え、さらに向きも回転させる
model.GlRotateWithVec(0.0, 10.0, 0.0, fk_Axis.X, 0.1);
\end{verbatim}
\end{screen}
\\

また、モデルには「継承関係」というモデル同士の関係を形成することが
できる。これは、複数のモデルをある1つのモデルに属した関係にするもので、
FK の中では前者を「子モデル」、後者を「親モデル」と呼んでいる。
親モデルを動かすと、それに従って子モデルも動いていく。従って、
この機能は複数のモデルを1つのモデルのように扱いたい場合に効果を発揮する。
具体的な応用としては第 \ref{chap:sample} 章の各サンプルが例として挙げられる。

\section{カメラと光源}
fk\_AppWindow クラスは、初期状態でカメラと光源が設定されている。
カメラの制御方法としては、前述したプログラムのような方法の他に、
fk\_Model 型変数をカメラとして扱うこともできる。
詳細は第 \ref{chap:window} 章で述べる。

光源については、デフォルトでは \((0, 0, -1)\) 方向の平行光源が設定されている。
これに対し、別の方向からの平行光源を設定したい場合や、
点光源などを設定したい場合は \(fk\_Light\) というクラスを用いて
光源を作成し、それを形状としてモデルに設定し、fk\_AppWindow に
モデルを登録するという手順を取る。詳細は \ref{chap:shape} の
光源に関する節で説明する。

\section{シーン}

「シーン」とは、一般的には描画すべき要素の集合のことを
指す。FK における「シーン」とは、モデルのデータベースとなっており、
意味的には空間全体を成すものである。従って、あるモデルを
描画するかどうかはシーンに対して対象モデルを登録したり
抹消すればよい。

fk\_AppWindow では、最初から一つのシーンが内部に登録されており、
そこへの登録は fk\_AppWindow の「Entry()」メソッドで行うことができる。
また、抹消は「Remove()」によって行う。

一方、アプリケーションによっては複数のシーンを使い分けたい場合がある。
異なるシーンをそれぞれ保持しておき、状況によってウィンドウに表示する
シーンを切り替えるような場合である。そのような機能を実現する手段として、
FK では「fk\_Scene」というクラスが用意されている。
このクラスはシーン中に表示するモデルの登録や抹消、そしてカメラを管理するものであり、
このクラスの変数を複数個用意することで、複数のシーンを容易に切り替えることができる。
また、マルチウィンドウアプリケーションを作成する場合にも利用することになる。
さらに、シーンには霧効果の設定など、
fk\_AppWindow よりも高度なシーン管理機能を利用することができる。
これらについては、第 \ref{chap:scene} 章で詳しく解説する。

% \section{ウィンドウと GUI}
% FK は、元々 OpenGL と FLTK というシステムを基盤に構築されている。このうち、
% OpenGL は 3D 描画のための機能であり、FLTK は
% グラフィカルユーザインターフェース (GUI) を作成するためのツールである。
% FK は、FLTK との強い親和性を意識して設計されており、FLTK の GUI 機能を
% そのまま利用することができる。その一例が \ref{chap:sample} 章の
% 「FLTK を用いた GUI 構築」というサンプルに示されている。

\section{デバイス状態取得}
多くのリアルタイムアプリケーションでは、マウスやキーボードなどに
よるリアルタイムな操作を必要とすることが多い。FK でも、
現時点でマウスの位置やボタン状態、キーボードの情報などを
ウィンドウオブジェクトから取得することができる。また、(やや高度な
トピックになるが)どの形状、どの頂点、どの面がピックされたかを
取得する機能も提供されている。これらの機能は、モデラーなどを
作成する際には必須の機能である。これらに関する事項は、
\ref{chap:window} 章を中心に記述されている。

\section{次の段階は.....}
以上が、FK の大体の概要説明である。FK は、もともとコンテンツ作成支援と
CG 研究支援の両方を目的としているため、ここでは紹介できないかなり専門的な
機能もある。例えば、FK では形状を変形する機能として最新の高度な CAD 技術が
用いられている。

もし、読者が CG、数学、プログラムの全てに初心者意識があるのならば、
次の順番に読み進めることをお勧めする。
\begin{center}
\ref{chap:sample} → \ref{chap:shape} → \ref{chap:material} →
\ref{chap:easygen} → \ref{chap:imagetexture} → \ref{chap:stringimage} →
\ref{chap:model} → \ref{chap:scene} → \ref{chap:window} →
\ref{chap:viewer} → \ref{chap:vector} → \ref{chap:sample} 
\end{center}
ある程度の CG プログラミングの経験があるのならば、次の順番で読み進めるのが
効率がよいだろう。
\begin{center}
\ref{chap:vector} → \ref{chap:material} → \ref{chap:shape} →
\ref{chap:easygen} → \ref{chap:imagetexture} → \ref{chap:stringimage} →
\ref{chap:model} → \ref{chap:scene} → \ref{chap:window} →
\ref{chap:viewer} → \ref{chap:sample}
\end{center}
FK を、3D 形状を利用した研究開発に利用する場合は、これに加えさらに
\ref{chap:solid} 章を読む必要があるだろう。

なんにしろ、読み方は自由である。各自で効果的な学習を試みてほしい。
